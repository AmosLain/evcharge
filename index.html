<!-- ‚úÖ Full updated file with the fixed loadStations() function -->
<!-- Only relevant sections shown here ‚Äî use this as your final version or override the current one -->
<!-- You can keep your current HTML/CSS as-is. Just replace your <script> block at the end of index.html with this: -->

<script>
    let allStations = [];
    let filteredStations = [];
    let currentPage = 1;
    const stationsPerPage = 20;

    document.addEventListener('DOMContentLoaded', function() {
        loadStations();
    });

    async function loadStations() {
        const stationContainer = document.getElementById('station-container');
        const statsElements = {
            total: document.querySelector('.stat-total'),
            networks: document.querySelector('.stat-networks'),
            states: document.querySelector('.stat-states'),
            fastChargers: document.querySelector('.stat-fast-chargers')
        };

        try {
            console.log('üöÄ Fetching stations via Netlify function...');
            stationContainer.innerHTML = '<div class="loading">Loading charging stations from NREL database...</div>';

            const response = await fetch('/.netlify/functions/stations', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error(`HTTP error ${response.status}`);

            const data = await response.json();

            if (!data.success) throw new Error(data.error || 'Function returned failure');

            allStations = data.stations || [];
            filteredStations = [...allStations];

            console.log(`‚úÖ Loaded ${allStations.length} stations from Netlify function`);

            updateStats(allStations, statsElements);
            displayStations();
            setupFilters();

        } catch (error) {
            console.error('‚ùå Error loading stations from Netlify function:', error);
            stationContainer.innerHTML = `
                <div class="error-message">
                    <h3>‚ö†Ô∏è Failed to Load Charging Stations</h3>
                    <p>${error.message}</p>
                    <button onclick="loadStations()" class="retry-btn">Retry</button>
                </div>
            `;
        }
    }

    function updateStats(stations, statsElements) {
        const totalStations = stations.length;
        const uniqueNetworks = new Set(stations.map(s => s.ev_network).filter(n => n)).size;
        const uniqueStates = new Set(stations.map(s => s.state).filter(s => s)).size;
        const fastChargers = stations.filter(s => s.ev_dc_fast_num && parseInt(s.ev_dc_fast_num) > 0).length;

        animateCounter(statsElements.total, totalStations);
        animateCounter(statsElements.networks, uniqueNetworks);
        animateCounter(statsElements.states, uniqueStates);
        animateCounter(statsElements.fastChargers, fastChargers);
    }

    function animateCounter(element, targetValue) {
        if (!element) return;
        let currentValue = 0;
        const increment = Math.ceil(targetValue / 50);
        const timer = setInterval(() => {
            currentValue += increment;
            if (currentValue >= targetValue) {
                currentValue = targetValue;
                clearInterval(timer);
            }
            element.textContent = currentValue.toLocaleString();
        }, 30);
    }

    function displayStations() {
        const stationContainer = document.getElementById('station-container');
        const startIndex = (currentPage - 1) * stationsPerPage;
        const endIndex = startIndex + stationsPerPage;
        const stationsToShow = filteredStations.slice(startIndex, endIndex);

        if (stationsToShow.length === 0) {
            stationContainer.innerHTML = '<div class="no-results">No charging stations found matching your criteria.</div>';
            return;
        }

        const stationsHTML = stationsToShow.map(station => `
            <div class="station-card">
                <div class="station-header">
                    <h3>${station.station_name || 'Unknown Station'}</h3>
                    <div class="network-badge">${station.ev_network || 'Independent'}</div>
                </div>
                <div class="station-info">
                    <p class="address">üìç ${station.street_address}, ${station.city}, ${station.state} ${station.zip}</p>
                    <div class="station-details">
                        <span class="detail-item">‚ö° ${station.ev_level1_evse_num || 0} Level 1</span>
                        <span class="detail-item">üîå ${station.ev_level2_evse_num || 0} Level 2</span>
                        <span class="detail-item">‚ö° ${station.ev_dc_fast_num || 0} DC Fast</span>
                    </div>
                    <div class="station-meta">
                        <span class="access-code">${station.access_code === 'public' ? 'üü¢ Public' : 'üü° ' + (station.access_code || 'Unknown')}</span>
                        <span class="status">${station.status_code === 'E' ? '‚úÖ Available' : '‚ùì Check Status'}</span>
                    </div>
                </div>
            </div>
        `).join('');

        stationContainer.innerHTML = stationsHTML + getPaginationHTML();
    }

    function getPaginationHTML() {
        const totalPages = Math.ceil(filteredStations.length / stationsPerPage);
        if (totalPages <= 1) return '';

        const prevDisabled = currentPage === 1 ? 'disabled' : '';
        const nextDisabled = currentPage === totalPages ? 'disabled' : '';

        return `
            <div class="pagination">
                <button onclick="changePage(${currentPage - 1})" ${prevDisabled}>Previous</button>
                <span>Page ${currentPage} of ${totalPages} (${filteredStations.length.toLocaleString()} stations)</span>
                <button onclick="changePage(${currentPage + 1})" ${nextDisabled}>Next</button>
            </div>
        `;
    }

    function changePage(newPage) {
        const totalPages = Math.ceil(filteredStations.length / stationsPerPage);
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            displayStations();
            document.getElementById('station-container').scrollIntoView({ behavior: 'smooth' });
        }
    }

    function setupFilters() {
        const stateFilter = document.getElementById('state-filter');
        const networkFilter = document.getElementById('network-filter');
        const chargerFilter = document.getElementById('charger-filter');

        const states = [...new Set(allStations.map(s => s.state).filter(s => s))].sort();
        stateFilter.innerHTML = '<option value="">All States</option>' +
            states.map(state => `<option value="${state}">${state}</option>`).join('');

        const networks = [...new Set(allStations.map(s => s.ev_network).filter(n => n))].sort();
        networkFilter.innerHTML = '<option value="">All Networks</option>' +
            networks.map(network => `<option value="${network}">${network}</option>`).join('');

        [stateFilter, networkFilter, chargerFilter].forEach(filter => {
            filter.addEventListener('change', applyFilters);
        });

        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', applyFilters);
        }
    }

    function applyFilters() {
        const stateFilter = document.getElementById('state-filter').value;
        const networkFilter = document.getElementById('network-filter').value;
        const chargerFilter = document.getElementById('charger-filter').value;
        const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';

        filteredStations = allStations.filter(station => {
            const matchesState = !stateFilter || station.state === stateFilter;
            const matchesNetwork = !networkFilter || station.ev_network === networkFilter;
            const matchesChargerType = !chargerFilter ||
                (chargerFilter === 'level1' && parseInt(station.ev_level1_evse_num) > 0) ||
                (chargerFilter === 'level2' && parseInt(station.ev_level2_evse_num) > 0) ||
                (chargerFilter === 'dcfast' && parseInt(station.ev_dc_fast_num) > 0);
            const matchesSearch = !searchTerm ||
                station.station_name?.toLowerCase().includes(searchTerm) ||
                station.city?.toLowerCase().includes(searchTerm) ||
                station.street_address?.toLowerCase().includes(searchTerm);

            return matchesState && matchesNetwork && matchesChargerType && matchesSearch;
        });

        currentPage = 1;
        displayStations();
    }
</script>
